import { createApp } from 'vue'
import App from './App.vue'
import router from './router'
import './index.css'

window.ChequeABI = [
  "function encryptionPubkeys(address) external view returns (uint)",
  "function getChequeContent(uint id) external view returns (address coinType, uint96 amount, address drawer, uint64 deadline, bytes32 passphraseHash)",
  "function setEncryptionPubkey(uint key, address referee) external",
  "function unsetEncryptionPubkey() external",
  "function writeCheques(address[] calldata payeeList, address coinType, uint96 amount, uint64 deadline, uint[] calldata passphraseHashList, bytes[] calldata memoList) external payable",
  "function writeCheque(address payee, address coinType, uint96 amount, uint64 deadline, uint passphraseHash, bytes calldata memo) external payable",
  "function revokeCheques(uint[] calldata idList) external",
  "function revokeCheque(uint id) public",
  "function acceptCheques(uint[] calldata idList, bytes calldata passphrase) external",
  "function refuseCheques(uint[] calldata idList) external",
  "function acceptCheque(uint id, bytes calldata passphrase) external",
  "function refuseCheque(uint id) external"]

window.chequeBytecode = "0x608060405234801561001057600080fd5b50611798806100206000396000f3fe6080604052600436106100a75760003560e01c80638e4e43a4116100645780638e4e43a4146101ce578063a15a890f146101ee578063cbc1228d1461020e578063cd0b8bee1461022e578063db8e238414610241578063f7fdc6dd1461025457600080fd5b8063163e7c62146100ac57806335cb33db146100ce578063537739161461010e5780635faf2263146101795780636653637f14610199578063876c07f4146101ae575b600080fd5b3480156100b857600080fd5b506100cc6100c7366004611578565b610274565b005b3480156100da57600080fd5b506100fb6100e9366004611329565b60016020526000908152604090205481565b6040519081526020015b60405180910390f35b34801561011a57600080fd5b5061012e610129366004611578565b610292565b604080516001600160a01b0396871681526001600160601b0395909516602086015292909416918301919091526001600160401b03166060820152608081019190915260a001610105565b34801561018557600080fd5b506100cc6101943660046114aa565b6102cd565b3480156101a557600080fd5b506100cc610323565b3480156101ba57600080fd5b506100cc6101c9366004611578565b61035d565b3480156101da57600080fd5b506100cc6101e93660046114aa565b610491565b3480156101fa57600080fd5b506100cc6102093660046114eb565b6104d4565b34801561021a57600080fd5b506100cc6102293660046115d6565b610552565b6100cc61023c3660046113da565b610594565b6100cc61024f36600461134b565b610934565b34801561026057600080fd5b506100cc61026f3660046115aa565b610bd8565b6040805160008082526020820190925261028f918391610c31565b50565b6000806000806000806102a487610e33565b8051602082015160408301516060840151608090940151929b919a509850919650945092505050565b60408051600080825260208201909252905b8281101561031d5761030b8484838181106102fc576102fc61174c565b90506020020135600084610c31565b806103158161171b565b9150506102df565b50505050565b33600081815260016020526040808220829055517f28f1a757c69b495383be7a1dfeb83d7d39c412913818674809b4fbac919e7aae9190a2565b600061036882610e33565b905080606001516001600160401b0316600014156103c15760405162461bcd60e51b81526020600482015260116024820152706368657175652d6e6f742d65786973747360781b60448201526064015b60405180910390fd5b4281606001516001600160401b0316106104155760405162461bcd60e51b81526020600482015260156024820152747374696c6c2d6265666f72652d646561646c696e6560581b60448201526064016103b8565b60008281526020819052604081208181556001810180546001600160e01b03191690556002015561045c8160000151826040015183602001516001600160601b0316610ecc565b6040518290606082901c907f498382dc758b987be80f8c9373d6d2c32509c955d7496ac3560fe7c832fb02cd90600090a35050565b60005b818110156104cf576104bd8383838181106104b1576104b161174c565b9050602002013561035d565b806104c78161171b565b915050610494565b505050565b60005b8381101561054b576105398585838181106104f4576104f461174c565b90506020020135600185858080601f016020809104026020016040519081016040528093929190818152602001838380828437600092019190915250610c3192505050565b806105438161171b565b9150506104d7565b5050505050565b6104cf83600184848080601f016020809104026020016040519081016040528093929190818152602001838380828437600092019190915250610c3192505050565b87831480156105a257508781145b6105e05760405162461bcd60e51b815260206004820152600f60248201526e0d8cadccee8d05adad2e6dac2e8c6d608b1b60448201526064016103b8565b42856001600160401b03161161062b5760405162461bcd60e51b815260206004820152601060248201526f696e76616c69642d646561646c696e6560801b60448201526064016103b8565b6001600160601b0386166001600160a01b038816612711141561069f5761065b896001600160601b0389166116e5565b341461069a5760405162461bcd60e51b815260206004820152600e60248201526d0ecc2d8eaca5adad2e6dac2e8c6d60931b60448201526064016103b8565b61089b565b34156106dd5760405162461bcd60e51b815260206004820152600d60248201526c0c8dedce85ae6cadcc85ac4c6d609b1b60448201526064016103b8565b6040516370a0823160e01b81523060048201526000906001600160a01b038a16906370a082319060240160206040518083038186803b15801561071f57600080fd5b505afa158015610733573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906107579190611591565b90506001600160a01b0389166323b872dd333061077d8e6001600160601b038e166116e5565b6040516001600160e01b031960e086901b1681526001600160a01b0393841660048201529290911660248301526044820152606401602060405180830381600087803b1580156107cc57600080fd5b505af11580156107e0573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906108049190611556565b506040516370a0823160e01b81523060048201526000906001600160a01b038b16906370a082319060240160206040518083038186803b15801561084757600080fd5b505afa15801561085b573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061087f9190611591565b90508a61088c8383611704565b61089691906116c3565b925050505b60005b89811015610927576109158b8b838181106108bb576108bb61174c565b90506020020160208101906108d09190611329565b8a848a8a8a878181106108e5576108e561174c565b905060200201358989888181106108fe576108fe61174c565b90506020028101906109109190611665565b610fbc565b8061091f8161171b565b91505061089e565b5050505050505050505050565b42846001600160401b03161161097f5760405162461bcd60e51b815260206004820152601060248201526f696e76616c69642d646561646c696e6560801b60448201526064016103b8565b6001600160601b0385166001600160a01b03871661271114156109ea57856001600160601b031634146109e55760405162461bcd60e51b815260206004820152600e60248201526d0ecc2d8eaca5adad2e6dac2e8c6d60931b60448201526064016103b8565b610bbf565b3415610a285760405162461bcd60e51b815260206004820152600d60248201526c0c8dedce85ae6cadcc85ac4c6d609b1b60448201526064016103b8565b6040516370a0823160e01b81523060048201526000906001600160a01b038916906370a082319060240160206040518083038186803b158015610a6a57600080fd5b505afa158015610a7e573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610aa29190611591565b6040516323b872dd60e01b81523360048201523060248201526001600160601b03891660448201529091506001600160a01b038916906323b872dd90606401602060405180830381600087803b158015610afb57600080fd5b505af1158015610b0f573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610b339190611556565b506040516370a0823160e01b81523060048201526000906001600160a01b038a16906370a082319060240160206040518083038186803b158015610b7657600080fd5b505afa158015610b8a573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610bae9190611591565b9050610bba8282611704565b925050505b610bce88888388888888610fbc565b5050505050505050565b3360008181526001602090815260409182902085905581516001600160a01b03851681529081018590527fca6ad40ddda258ce3df984c1c58b35dd1fa465dd19cbecba7346a98c7008453b910160405180910390a25050565b33606084901c14610c705760405162461bcd60e51b81526020600482015260096024820152686e6f742d706179656560b81b60448201526064016103b8565b6000610c7b84610e33565b905080606001516001600160401b031660001415610ccf5760405162461bcd60e51b81526020600482015260116024820152706368657175652d6e6f742d65786973747360781b60448201526064016103b8565b80606001516001600160401b0316421115610d1d5760405162461bcd60e51b815260206004820152600e60248201526d61667465722d646561646c696e6560901b60448201526064016103b8565b338315610dbc5760f88260800151901c602314610d8a57825160208401206080830151600882811b91901b14610d885760405162461bcd60e51b815260206004820152601060248201526f77726f6e672d7061737370687261736560801b60448201526064016103b8565b505b604051859033907f917b75dc2ba1f71d686e1c0a6d23ee1ce1dbf74fd6a321538520e805b419b11b90600090a3610df0565b506040808201519051859033907f4dbe344e3bc0399b7470ba6f976610e66f705c494e65f6feebdd154b16ce8d0590600090a35b60008581526020819052604081208181556001810180546001600160e01b03191690556002015561054b82600001518284602001516001600160601b0316610ecc565b6040805160a0810182526000808252602082018190529181018290526060810182905260808101919091525060009081526020818152604091829020825160a08101845281546001600160a01b038082168352600160a01b918290046001600160601b031694830194909452600183015493841694820194909452929091046001600160401b0316606083015260020154608082015290565b6001600160a01b0383166127111415610f3a576040516001600160a01b038316906123289083906000818181858888f193505050503d8060008114610f2d576040519150601f19603f3d011682016040523d82523d6000602084013e610f32565b606091505b505050505050565b60405163a9059cbb60e01b81526001600160a01b0383811660048301526024820183905284169063a9059cbb90604401602060405180830381600087803b158015610f8457600080fd5b505af1158015610f98573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061031d9190611556565b6001600160a01b0387166000908152600160205260409020546110115760405162461bcd60e51b815260206004820152600d60248201526c6e6f2d656e632d7075626b657960981b60448201526064016103b8565b61101e4262278d006116ab565b846001600160401b0316106110755760405162461bcd60e51b815260206004820152601a60248201527f646561646c696e652d6d7573742d696e2d6f6e652d6d6f6e746800000000000060448201526064016103b8565b336bffffffffffffffffffffffff19606089901b164360201b1763ffffff00600883901b16175b60008181526020818152604091829020825160a08101845281546001600160a01b038082168352600160a01b918290046001600160601b031694830194909452600183015493841694820194909452929091046001600160401b03166060830181905260029091015460809092019190915215611125578061111d8161171b565b91505061109c565b6040805160a081018252338183019081526001600160401b03898116606084019081526001600160a01b038d81168552608085018b81526001600160601b038e8116602080890191825260008b8152908190529890982087519851909116600160a01b908102988416989098178155945160018601805494519095169097026001600160e01b031990931696909116959095171790559151600290920191909155604080516bffffffffffffffffffffffff1960608c901b166001600160601b038b16179142901b6001600160401b038a161790339085906001600160a01b038f16907f5a8039e362c5082b85db686c7a1ba5274e97d4bf7af46f352f3fcb60d9b3903e9061123d90879087908f908f908f90611621565b60405180910390a4505050505050505050505050565b80356001600160a01b038116811461126a57600080fd5b919050565b60008083601f84011261128157600080fd5b5081356001600160401b0381111561129857600080fd5b6020830191508360208260051b85010111156112b357600080fd5b9250929050565b60008083601f8401126112cc57600080fd5b5081356001600160401b038111156112e357600080fd5b6020830191508360208285010111156112b357600080fd5b80356001600160401b038116811461126a57600080fd5b80356001600160601b038116811461126a57600080fd5b60006020828403121561133b57600080fd5b61134482611253565b9392505050565b600080600080600080600060c0888a03121561136657600080fd5b61136f88611253565b965061137d60208901611253565b955061138b60408901611312565b9450611399606089016112fb565b93506080880135925060a08801356001600160401b038111156113bb57600080fd5b6113c78a828b016112ba565b989b979a50959850939692959293505050565b600080600080600080600080600060c08a8c0312156113f857600080fd5b89356001600160401b038082111561140f57600080fd5b61141b8d838e0161126f565b909b50995089915061142f60208d01611253565b985061143d60408d01611312565b975061144b60608d016112fb565b965060808c013591508082111561146157600080fd5b61146d8d838e0161126f565b909650945060a08c013591508082111561148657600080fd5b506114938c828d0161126f565b915080935050809150509295985092959850929598565b600080602083850312156114bd57600080fd5b82356001600160401b038111156114d357600080fd5b6114df8582860161126f565b90969095509350505050565b6000806000806040858703121561150157600080fd5b84356001600160401b038082111561151857600080fd5b6115248883890161126f565b9096509450602087013591508082111561153d57600080fd5b5061154a878288016112ba565b95989497509550505050565b60006020828403121561156857600080fd5b8151801515811461134457600080fd5b60006020828403121561158a57600080fd5b5035919050565b6000602082840312156115a357600080fd5b5051919050565b600080604083850312156115bd57600080fd5b823591506115cd60208401611253565b90509250929050565b6000806000604084860312156115eb57600080fd5b8335925060208401356001600160401b0381111561160857600080fd5b611614868287016112ba565b9497909650939450505050565b85815284602082015283604082015260806060820152816080820152818360a0830137600081830160a090810191909152601f909201601f19160101949350505050565b6000808335601e1984360301811261167c57600080fd5b8301803591506001600160401b0382111561169657600080fd5b6020019150368190038213156112b357600080fd5b600082198211156116be576116be611736565b500190565b6000826116e057634e487b7160e01b600052601260045260246000fd5b500490565b60008160001904831182151516156116ff576116ff611736565b500290565b60008282101561171657611716611736565b500390565b600060001982141561172f5761172f611736565b5060010190565b634e487b7160e01b600052601160045260246000fd5b634e487b7160e01b600052603260045260246000fdfea2646970667358221220186a09c8cd35c0baf75c7e1fc456de4a918c81e69aa0996efd9c1d8cdd97b0c064736f6c63430008060033"
	
window.SEP20ABI = [
    "function name() view returns (string)",
    "function symbol() view returns (string)",
    "function decimals() view returns (uint8)",
    "function totalSupply() external view returns (uint256)",
    "function balanceOf(address account) external view returns (uint256)",
    "function transfer(address recipient, uint256 amount) external returns (bool)",
    "function allowance(address owner, address spender) external view returns (uint256)",
    "function approve(address spender, uint256 amount) external returns (bool)",
    "function transferFrom(address sender, address recipient, uint256 amount) external returns (bool)",
    "event Transfer(address indexed from, address indexed to, uint256 value)",
    "event Approval(address indexed owner, address indexed spender, uint256 value)"]

window.ChequeContractAddress = "0xbB42Dc067892f24ce26281e00e532E0CE40b5e37"

window.alertNoWallet = () => {
      alert("No wallet installed! Please install MetaMask or other web3 wallet to use this App.");
}

if (typeof window.ethereum === 'undefined') {
  alertNoWallet()
} else {
  ethereum.request({ method: 'eth_requestAccounts' })
}

window.getSEP20AddrAndSymbol = async function(line) {
      var trimmed = line.trim()
      if(trimmed.length!=42) {//not hex, so it is a symbol
         const hexAddr = localStorage.getItem("coin-"+trimmed)
	 if(trimmed === null) {
	   alert("Cannot find "+trimmed+"'s address in history. Please enter a HEX address.")
	   return [null, null]
	 }
	 trimmed = hexAddr
      }
      var sep20Addr, symbol;
      try {
        sep20Addr = ethers.utils.getAddress(trimmed)
      } catch(e) {
        alert("Invalid Address: "+trimmed)
	return [null, null]
      }
      const provider = new ethers.providers.Web3Provider(window.ethereum)
      const sep20Contract = new ethers.Contract(sep20Addr, SEP20ABI, provider)
      try {
        symbol = await sep20Contract.symbol()
      } catch(e) {
        alert("Not an SEP20 Address: "+sep20Addr)
	return [null, null]
      }
      localStorage.setItem("coin-"+symbol, sep20Addr)
      return [sep20Addr, symbol]
}

window.uint8ArrayToHex = function(buffer) {
  return Array.prototype.map.call(buffer, x => x.toString(16).padStart(2, '0')).join('');
}

window.strToBytes32Hex = function(s) {
  const encoder = new TextEncoder()
  const encData = encoder.encode(s)
  const hex = uint8ArrayToHex(encData)
  return "0x"+hex+("0".repeat(Math.max(0, 64-hex.length)))
}

createApp(App).use(router).mount('#app')

// Account1: 0x5637c9fbFf9FAf5f534d0a88199feCD97357635B
// Account2: 0xd6c5F62c58238bfF1210b53ED5d1b2224EBC5176
// Account3: 0x732B170AB666146ea3752c81b27E85d215EEb190
// ABC: 0xcbfe5fdc8d21b1bf199f7d2a19910452989de9b6

