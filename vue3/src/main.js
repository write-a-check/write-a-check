import { createApp } from 'vue'
import App from './App.vue'
import router from './router'
import './index.css'

window.ChequeABI = [
  "function encryptionPubkeys(address) external view returns (uint)",
  "function getChequeContent(uint id) external view returns (address coinType, uint96 amount, address drawer, uint64 deadline, bytes32 passphraseHash)",
  "function setEncryptionPubkey(uint key, address referee) external",
  "function unsetEncryptionPubkey() external",
  "function writeCheques(address[] calldata payeeList, address coinType, uint96 amount, uint64 deadline, uint[] calldata passphraseHashList, bytes[] calldata memoList) external payable",
  "function writeCheque(address payee, address coinType, uint96 amount, uint64 deadline, uint passphraseHash, bytes calldata memo) external payable",
  "function revokeCheques(uint[] calldata idList) external",
  "function revokeCheque(uint id) public",
  "function acceptCheques(uint[] calldata idList, bytes calldata passphrase) external",
  "function refuseCheques(uint[] calldata idList) external",
  "function acceptCheque(uint id, bytes calldata passphrase) external",
  "function refuseCheque(uint id) external"]

window.chequeBytecode = "0x608060405234801561001057600080fd5b506117d3806100206000396000f3fe6080604052600436106100a75760003560e01c80638e4e43a4116100645780638e4e43a4146101ce578063a15a890f146101ee578063cbc1228d1461020e578063cd0b8bee1461022e578063db8e238414610241578063f7fdc6dd1461025457600080fd5b8063163e7c62146100ac57806335cb33db146100ce578063537739161461010e5780635faf2263146101795780636653637f14610199578063876c07f4146101ae575b600080fd5b3480156100b857600080fd5b506100cc6100c73660046115b3565b610274565b005b3480156100da57600080fd5b506100fb6100e9366004611364565b60016020526000908152604090205481565b6040519081526020015b60405180910390f35b34801561011a57600080fd5b5061012e6101293660046115b3565b610292565b604080516001600160a01b0396871681526001600160601b0395909516602086015292909416918301919091526001600160401b03166060820152608081019190915260a001610105565b34801561018557600080fd5b506100cc6101943660046114e5565b6102cd565b3480156101a557600080fd5b506100cc610323565b3480156101ba57600080fd5b506100cc6101c93660046115b3565b61035d565b3480156101da57600080fd5b506100cc6101e93660046114e5565b6104a9565b3480156101fa57600080fd5b506100cc610209366004611526565b6104ec565b34801561021a57600080fd5b506100cc610229366004611611565b61056a565b6100cc61023c366004611415565b6105ac565b6100cc61024f366004611386565b61094c565b34801561026057600080fd5b506100cc61026f3660046115e5565b610bf0565b6040805160008082526020820190925261028f918391610c49565b50565b6000806000806000806102a487610e6e565b8051602082015160408301516060840151608090940151929b919a509850919650945092505050565b60408051600080825260208201909252905b8281101561031d5761030b8484838181106102fc576102fc611787565b90506020020135600084610c49565b8061031581611756565b9150506102df565b50505050565b33600081815260016020526040808220829055517f28f1a757c69b495383be7a1dfeb83d7d39c412913818674809b4fbac919e7aae9190a2565b600061036882610e6e565b905080606001516001600160401b0316600014156103c15760405162461bcd60e51b81526020600482015260116024820152706368657175652d6e6f742d65786973747360781b60448201526064015b60405180910390fd5b4281606001516001600160401b0316106104155760405162461bcd60e51b81526020600482015260156024820152747374696c6c2d6265666f72652d646561646c696e6560581b60448201526064016103b8565b60008281526020819052604081208181556001810180546001600160e01b03191690556002015561045c8160000151826040015183602001516001600160601b0316610f07565b80604001516001600160a01b031682606084901c6001600160a01b03167f55282b3ab21725a5295da66b30787da30fca15979218d125e98dc4a9776d9f0760405160405180910390a45050565b60005b818110156104e7576104d58383838181106104c9576104c9611787565b9050602002013561035d565b806104df81611756565b9150506104ac565b505050565b60005b838110156105635761055185858381811061050c5761050c611787565b90506020020135600185858080601f016020809104026020016040519081016040528093929190818152602001838380828437600092019190915250610c4992505050565b8061055b81611756565b9150506104ef565b5050505050565b6104e783600184848080601f016020809104026020016040519081016040528093929190818152602001838380828437600092019190915250610c4992505050565b87831480156105ba57508781145b6105f85760405162461bcd60e51b815260206004820152600f60248201526e0d8cadccee8d05adad2e6dac2e8c6d608b1b60448201526064016103b8565b42856001600160401b0316116106435760405162461bcd60e51b815260206004820152601060248201526f696e76616c69642d646561646c696e6560801b60448201526064016103b8565b6001600160601b0386166001600160a01b03881661271114156106b757610673896001600160601b038916611720565b34146106b25760405162461bcd60e51b815260206004820152600e60248201526d0ecc2d8eaca5adad2e6dac2e8c6d60931b60448201526064016103b8565b6108b3565b34156106f55760405162461bcd60e51b815260206004820152600d60248201526c0c8dedce85ae6cadcc85ac4c6d609b1b60448201526064016103b8565b6040516370a0823160e01b81523060048201526000906001600160a01b038a16906370a082319060240160206040518083038186803b15801561073757600080fd5b505afa15801561074b573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061076f91906115cc565b90506001600160a01b0389166323b872dd33306107958e6001600160601b038e16611720565b6040516001600160e01b031960e086901b1681526001600160a01b0393841660048201529290911660248301526044820152606401602060405180830381600087803b1580156107e457600080fd5b505af11580156107f8573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061081c9190611591565b506040516370a0823160e01b81523060048201526000906001600160a01b038b16906370a082319060240160206040518083038186803b15801561085f57600080fd5b505afa158015610873573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061089791906115cc565b90508a6108a4838361173f565b6108ae91906116fe565b925050505b60005b8981101561093f5761092d8b8b838181106108d3576108d3611787565b90506020020160208101906108e89190611364565b8a848a8a8a878181106108fd576108fd611787565b9050602002013589898881811061091657610916611787565b905060200281019061092891906116a0565b610ff7565b8061093781611756565b9150506108b6565b5050505050505050505050565b42846001600160401b0316116109975760405162461bcd60e51b815260206004820152601060248201526f696e76616c69642d646561646c696e6560801b60448201526064016103b8565b6001600160601b0385166001600160a01b0387166127111415610a0257856001600160601b031634146109fd5760405162461bcd60e51b815260206004820152600e60248201526d0ecc2d8eaca5adad2e6dac2e8c6d60931b60448201526064016103b8565b610bd7565b3415610a405760405162461bcd60e51b815260206004820152600d60248201526c0c8dedce85ae6cadcc85ac4c6d609b1b60448201526064016103b8565b6040516370a0823160e01b81523060048201526000906001600160a01b038916906370a082319060240160206040518083038186803b158015610a8257600080fd5b505afa158015610a96573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610aba91906115cc565b6040516323b872dd60e01b81523360048201523060248201526001600160601b03891660448201529091506001600160a01b038916906323b872dd90606401602060405180830381600087803b158015610b1357600080fd5b505af1158015610b27573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610b4b9190611591565b506040516370a0823160e01b81523060048201526000906001600160a01b038a16906370a082319060240160206040518083038186803b158015610b8e57600080fd5b505afa158015610ba2573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610bc691906115cc565b9050610bd2828261173f565b925050505b610be688888388888888610ff7565b5050505050505050565b3360008181526001602090815260409182902085905581516001600160a01b03851681529081018590527fca6ad40ddda258ce3df984c1c58b35dd1fa465dd19cbecba7346a98c7008453b910160405180910390a25050565b33606084901c14610c885760405162461bcd60e51b81526020600482015260096024820152686e6f742d706179656560b81b60448201526064016103b8565b6000610c9384610e6e565b905080606001516001600160401b031660001415610ce75760405162461bcd60e51b81526020600482015260116024820152706368657175652d6e6f742d65786973747360781b60448201526064016103b8565b80606001516001600160401b0316421115610d355760405162461bcd60e51b815260206004820152600e60248201526d61667465722d646561646c696e6560901b60448201526064016103b8565b338315610dec5760f88260800151901c602314610da257825160208401206080830151600882811b91901b14610da05760405162461bcd60e51b815260206004820152601060248201526f77726f6e672d7061737370687261736560801b60448201526064016103b8565b505b81604001516001600160a01b031685336001600160a01b03167f7c034fd89f31e2055d33b52660024ed09002226149a00e494a58472ef7f1ed7f60405160405180910390a4610e2b565b5060408082015190516001600160a01b03821690869033907fb92b62a11bbc0d8411fb5a2c72f4b0b51ea1b3df1849b2b6deca43a97a8bdd4290600090a45b60008581526020819052604081208181556001810180546001600160e01b03191690556002015561056382600001518284602001516001600160601b0316610f07565b6040805160a0810182526000808252602082018190529181018290526060810182905260808101919091525060009081526020818152604091829020825160a08101845281546001600160a01b038082168352600160a01b918290046001600160601b031694830194909452600183015493841694820194909452929091046001600160401b0316606083015260020154608082015290565b6001600160a01b0383166127111415610f75576040516001600160a01b038316906123289083906000818181858888f193505050503d8060008114610f68576040519150601f19603f3d011682016040523d82523d6000602084013e610f6d565b606091505b505050505050565b60405163a9059cbb60e01b81526001600160a01b0383811660048301526024820183905284169063a9059cbb90604401602060405180830381600087803b158015610fbf57600080fd5b505af1158015610fd3573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061031d9190611591565b6001600160a01b03871660009081526001602052604090205461104c5760405162461bcd60e51b815260206004820152600d60248201526c6e6f2d656e632d7075626b657960981b60448201526064016103b8565b6110594262278d006116e6565b846001600160401b0316106110b05760405162461bcd60e51b815260206004820152601a60248201527f646561646c696e652d6d7573742d696e2d6f6e652d6d6f6e746800000000000060448201526064016103b8565b336bffffffffffffffffffffffff19606089901b164360201b1763ffffff00600883901b16175b60008181526020818152604091829020825160a08101845281546001600160a01b038082168352600160a01b918290046001600160601b031694830194909452600183015493841694820194909452929091046001600160401b03166060830181905260029091015460809092019190915215611160578061115881611756565b9150506110d7565b6040805160a081018252338183019081526001600160401b03898116606084019081526001600160a01b038d81168552608085018b81526001600160601b038e8116602080890191825260008b8152908190529890982087519851909116600160a01b908102988416989098178155945160018601805494519095169097026001600160e01b031990931696909116959095171790559151600290920191909155604080516bffffffffffffffffffffffff1960608c901b166001600160601b038b16179142901b6001600160401b038a161790339085906001600160a01b038f16907f5a8039e362c5082b85db686c7a1ba5274e97d4bf7af46f352f3fcb60d9b3903e9061127890879087908f908f908f9061165c565b60405180910390a4505050505050505050505050565b80356001600160a01b03811681146112a557600080fd5b919050565b60008083601f8401126112bc57600080fd5b5081356001600160401b038111156112d357600080fd5b6020830191508360208260051b85010111156112ee57600080fd5b9250929050565b60008083601f84011261130757600080fd5b5081356001600160401b0381111561131e57600080fd5b6020830191508360208285010111156112ee57600080fd5b80356001600160401b03811681146112a557600080fd5b80356001600160601b03811681146112a557600080fd5b60006020828403121561137657600080fd5b61137f8261128e565b9392505050565b600080600080600080600060c0888a0312156113a157600080fd5b6113aa8861128e565b96506113b86020890161128e565b95506113c66040890161134d565b94506113d460608901611336565b93506080880135925060a08801356001600160401b038111156113f657600080fd5b6114028a828b016112f5565b989b979a50959850939692959293505050565b600080600080600080600080600060c08a8c03121561143357600080fd5b89356001600160401b038082111561144a57600080fd5b6114568d838e016112aa565b909b50995089915061146a60208d0161128e565b985061147860408d0161134d565b975061148660608d01611336565b965060808c013591508082111561149c57600080fd5b6114a88d838e016112aa565b909650945060a08c01359150808211156114c157600080fd5b506114ce8c828d016112aa565b915080935050809150509295985092959850929598565b600080602083850312156114f857600080fd5b82356001600160401b0381111561150e57600080fd5b61151a858286016112aa565b90969095509350505050565b6000806000806040858703121561153c57600080fd5b84356001600160401b038082111561155357600080fd5b61155f888389016112aa565b9096509450602087013591508082111561157857600080fd5b50611585878288016112f5565b95989497509550505050565b6000602082840312156115a357600080fd5b8151801515811461137f57600080fd5b6000602082840312156115c557600080fd5b5035919050565b6000602082840312156115de57600080fd5b5051919050565b600080604083850312156115f857600080fd5b823591506116086020840161128e565b90509250929050565b60008060006040848603121561162657600080fd5b8335925060208401356001600160401b0381111561164357600080fd5b61164f868287016112f5565b9497909650939450505050565b85815284602082015283604082015260806060820152816080820152818360a0830137600081830160a090810191909152601f909201601f19160101949350505050565b6000808335601e198436030181126116b757600080fd5b8301803591506001600160401b038211156116d157600080fd5b6020019150368190038213156112ee57600080fd5b600082198211156116f9576116f9611771565b500190565b60008261171b57634e487b7160e01b600052601260045260246000fd5b500490565b600081600019048311821515161561173a5761173a611771565b500290565b60008282101561175157611751611771565b500390565b600060001982141561176a5761176a611771565b5060010190565b634e487b7160e01b600052601160045260246000fd5b634e487b7160e01b600052603260045260246000fdfea264697066735822122012036d40a75a7a2785bbf060d171ff9b0bee278f1a9cb618246823f8859d971f64736f6c63430008060033"
	
window.SEP20ABI = [
    "function name() view returns (string)",
    "function symbol() view returns (string)",
    "function decimals() view returns (uint8)",
    "function totalSupply() external view returns (uint256)",
    "function balanceOf(address account) external view returns (uint256)",
    "function transfer(address recipient, uint256 amount) external returns (bool)",
    "function allowance(address owner, address spender) external view returns (uint256)",
    "function approve(address spender, uint256 amount) external returns (bool)",
    "function transferFrom(address sender, address recipient, uint256 amount) external returns (bool)",
    "event Transfer(address indexed from, address indexed to, uint256 value)",
    "event Approval(address indexed owner, address indexed spender, uint256 value)"]

window.ChequeContractAddress = "0xE30F36168b591D433e8e06b64f28263eC1014413"

window.alertNoWallet = () => {
      alert("No wallet installed! Please install MetaMask or other web3 wallet to use this App.");
}

if (typeof window.ethereum === 'undefined') {
  alertNoWallet()
} else {
  ethereum.request({ method: 'eth_requestAccounts' })
}

window.getSEP20AddrAndSymbol = async function(line) {
      var trimmed = line.trim()
      if(trimmed.length!=42) {//not hex, so it is a symbol
         const hexAddr = localStorage.getItem("coin-"+trimmed)
	 if(trimmed === null) {
	   alert("Cannot find "+trimmed+"'s address in history. Please enter a HEX address.")
	   return [null, null]
	 }
	 trimmed = hexAddr
      }
      var sep20Addr, symbol;
      try {
        sep20Addr = ethers.utils.getAddress(trimmed)
      } catch(e) {
        alert("Invalid Address: "+trimmed)
	return [null, null]
      }
      const provider = new ethers.providers.Web3Provider(window.ethereum)
      const sep20Contract = new ethers.Contract(sep20Addr, SEP20ABI, provider)
      try {
        symbol = await sep20Contract.symbol()
      } catch(e) {
        alert("Not an SEP20 Address: "+sep20Addr)
	return [null, null]
      }
      localStorage.setItem("coin-"+symbol, sep20Addr)
      return [sep20Addr, symbol]
}

window.timestamp2string = function(timestamp) {
  var t = new Date()
  t.setTime(timestamp)
  return t.toLocaleString()
}

window.uint8ArrayToHex = function(buffer) {
  return Array.prototype.map.call(buffer, x => x.toString(16).padStart(2, '0')).join('');
}

window.strToBytes32Hex = function(s) {
  const encoder = new TextEncoder()
  const encData = encoder.encode(s)
  const hex = uint8ArrayToHex(encData)
  return "0x"+hex+("0".repeat(Math.max(0, 64-hex.length)))
}

window.uint8ArrayFromHex = function(s) {
  var u8arr = new Uint8Array(Math.ceil(s.length / 2));
  for (var i = 0; i < u8arr.length; i++) {
    u8arr[i] = parseInt(s.substr(i * 2, 2), 16);
  }
  return u8arr
}

window.strFromHex = function(hex) {
  const data = uint8ArrayFromHex(hex)
  const decoder = new TextDecoder("utf-8")
  return decoder.decode(data)
}

window.getCoinSymbolAndDecimals = async function(coinInfoMap, coinType) {
  if(coinInfoMap.has(coinType)) {
    return coinInfoMap.get(coinType)
  }
  const provider = new ethers.providers.Web3Provider(window.ethereum)
  const sep20Contract = new ethers.Contract(coinType, SEP20ABI, provider)
  const symbol = await sep20Contract.symbol()
  const decimals = await sep20Contract.decimals()
  coinInfoMap.set(coinType, [symbol, decimals])
  return [symbol, decimals]
}

window.parseNewCheque = async function(coinInfoMap, topics, data) {
  var cheque = {}
  cheque.drawer = ethers.utils.getAddress("0x"+topics[3].substr(26))
  cheque.id = topics[2]
  cheque.payee = ethers.utils.getAddress("0x"+topics[1].substr(26))
  const coinTypeAndAmount = data.substr(2, 64)
  const startAndEndTime = data.substr(2+64, 64)
  cheque.passphraseHash = "0x"+data.substr(2+64*2, 64)
  const memoLength = ethers.BigNumber.from("0x"+data.substr(2+64*4, 64)).toNumber()
  cheque.encryptedMemo = "0x"+data.substr(2+64*5, memoLength*2) //skip memo's offset and length
  cheque.coinType = ethers.utils.getAddress("0x"+coinTypeAndAmount.substr(0, 20*2))
  const [symbol, decimals] = await getCoinSymbolAndDecimals(coinInfoMap, cheque.coinType)
  cheque.coinSymbol = symbol
  const amt = ethers.BigNumber.from("0x"+coinTypeAndAmount.substr(20*2, 12*2))
  cheque.amount = ethers.utils.formatUnits(amt, decimals)
  cheque.startTime = ethers.BigNumber.from("0x"+startAndEndTime.substr(16*2, 8*2)).toNumber()
  cheque.deadline = ethers.BigNumber.from("0x"+startAndEndTime.substr(24*2, 8*2)).toNumber()
  cheque.startTimeStr = timestamp2string(cheque.startTime*1000)
  cheque.deadlineStr = timestamp2string(cheque.deadline*1000)
  cheque.hasTag = cheque.passphraseHash.substr(2,2) == "23" // 0x23 is '#'
  if(cheque.deadline*1000 <= Date.now()) {
    cheque.status = "expired"
  } else {
    cheque.status = "active"
  }
  if(cheque.hasTag) cheque.tag = strFromHex(cheque.passphraseHash)
  return cheque
}

window.NewCheque = ethers.utils.id("NewCheque(address,uint256,address,uint256,uint256,uint256,bytes)")
window.RevokeCheque = ethers.utils.id("RevokeCheque(address,uint256,address)")
window.AcceptCheque = ethers.utils.id("AcceptCheque(address,uint256,address)")
window.RefuseCheque = ethers.utils.id("RefuseCheque(address,uint256,address)")
// const SetEncryptionPubkey = ethers.utils.id("SetEncryptionPubkey(address,address,uint256)")
// const UnsetEncryptionPubkey = ethers.utils.id("UnsetEncryptionPubkey(address)")

createApp(App).use(router).mount('#app')

// Account1: 0x5637c9fbFf9FAf5f534d0a88199feCD97357635B
// Account2: 0xd6c5F62c58238bfF1210b53ED5d1b2224EBC5176
// Account3: 0x732B170AB666146ea3752c81b27E85d215EEb190
// ABC: 0xcbfe5fdc8d21b1bf199f7d2a19910452989de9b6

